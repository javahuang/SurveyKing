(self.webpackChunksurvey_king=self.webpackChunksurvey_king||[]).push([[2235],{32235:function(W,P,d){"use strict";d.d(P,{b:function(){return Z}});var A=d(11849),v=d(39428),B=d(34792),L=d(48086),m=d(3182),j=d(69610),M=d(54941),S=d(91220),y=d(3980),s=d(54531),k=d(36855),C=d(42238),U=d.n(C),w=d(44335),p=(w.XZ===null||w.XZ===void 0?void 0:(0,w.XZ)())||[],E=function(t){if(!(!t||!p.length)){var e=t.replace("_","-").toLowerCase(),i=p.map(function(n){return n.toLowerCase()}),r=i.findIndex(function(n){return n===e});if(r>=0)return p[r];var a=e.split("-")[0],o=i.findIndex(function(n){return n.split("-")[0]===a});if(o>=0)return p[o]}},R=function(){if(typeof navigator!="undefined"){var t=(Array.isArray(navigator.languages)&&navigator.languages.length?navigator.languages:[navigator.language])||[],e=(0,S.Z)(t),i;try{for(e.s();!(i=e.n()).done;){var r=i.value,a=E(r);if(a)return a}}catch(o){e.e(o)}finally{e.f()}}},Z=function(){function I(t){var e;(0,j.Z)(this,I),this.id=void 0,this.project=void 0,this.survey=void 0,this.loading=void 0,this.verifying=!1,this.saving=!1,this.isPC=void 0,this.errorCode=void 0,this.errorMessage=void 0,this.progress=0,this.confirmTempAnswerType=0,this.statistics=void 0,this.answerUrl=void 0,this.answerQrCodeUrl=void 0,this.loginRequired=void 0,this.whitelistName=void 0,this.success=void 0,this.answerId=void 0,this.repoId=void 0,this.examExerciseType=void 0,this.answerView=void 0,this.values=void 0,this.initialQuestionScore=void 0,this.openId=void 0,this.token=void 0,this.surveyRef=void 0,this.id=t.id,this.answerId=t.answerId,this.surveyRef=t.surveyRef,this.repoId=t.repoId,this.examExerciseType=t.examExerciseType;var i=k.parse(window.location.search);i&&(this.openId=i.openId,this.token=i["sk-token"]),this.makeObservable(),this.loadProject(),this.confirmTempAnswerType=(e=this.savedAnswer)!==null&&e!==void 0&&e.progress?1:0}return(0,M.Z)(I,[{key:"makeObservable",value:function(){(0,s.Ou)(this,{id:s.LO.ref,answerId:s.LO.ref,survey:s.LO.ref,loading:s.LO.ref,saving:s.LO.ref,verifying:s.LO.ref,project:s.LO.ref,errorCode:s.LO.ref,errorMessage:s.LO.ref,progress:s.LO.ref,confirmTempAnswerType:s.LO.ref,statistics:s.LO.ref,answerUrl:s.LO.ref,answerQrCodeUrl:s.LO.ref,success:s.LO.ref,answerView:s.LO.ref,values:s.LO.ref,loginRequired:s.LO.ref,whitelistName:s.LO.ref,openId:s.LO.ref,token:s.LO.ref,passwordRequired:s.LO.computed,mode:s.LO.computed,tempSaveId:s.LO.computed,status:s.LO.computed,setting:s.LO.computed,tempSave:s.aD,saveData:s.aD,loadProject:s.aD,changeProgress:s.aD,validate:s.aD})}},{key:"setting",get:function(){var e;return(e=this.project)===null||e===void 0?void 0:e.setting}},{key:"status",get:function(){var e;return(e=this.project)===null||e===void 0?void 0:e.status}},{key:"passwordRequired",get:function(){var e;return(e=this.project)===null||e===void 0?void 0:e.passwordRequired}},{key:"mode",get:function(){var e;return(e=this.project)===null||e===void 0?void 0:e.mode}},{key:"tempSaveId",get:function(){return"savedAnswer-"+this.id}},{key:"savedAnswer",get:function(){var e=localStorage.getItem(this.tempSaveId);return e&&JSON.parse(e)}},{key:"startTime",get:function(){var e,i,r;return((e=this.savedAnswer)===null||e===void 0||(i=e.metaInfo)===null||i===void 0||(r=i.answerInfo)===null||r===void 0?void 0:r.startTime)||new Date().getTime()}},{key:"applyAnswerLocale",value:function(e){if(!!p.length){var i=E(e)||R()||p[0];i&&i!==(0,w.Kd)()&&(0,w.i_)(i,!1)}}},{key:"tempSave",value:function(e){var i=localStorage.getItem(this.tempSaveId),r;i?(r=JSON.parse(i),r.answer=e,r.progress=this.progress):r={answer:e,metaInfo:{answerInfo:{startTime:new Date().getTime()}},progress:this.progress},localStorage.setItem(this.tempSaveId,JSON.stringify(r))}},{key:"saveData",value:function(){var t=(0,m.Z)((0,v.Z)().mark(function i(r,a){var o,n,u=this,l,_,g,f,T,D,O,b,h;return(0,v.Z)().wrap(function(c){for(;;)switch(c.prev=c.next){case 0:if(l=a||{},_=l.answerId,g=l.forceSubmit,this.saving=!0,f=new(U())().getResult(),T={answer:r,projectId:this.id,metaInfo:{answerInfo:{startTime:this.startTime,endTime:new Date().getTime()},clientInfo:{browser:f.browser.name||"",browserVersion:f.browser.version||"",deviceType:f.device.type||"",platform:f.os.name||"",platformVersion:f.os.version||""}},id:_||this.answerId,whitelistName:this.whitelistName},D=this.startTime,O=((o=this.project)===null||o===void 0||(n=o.setting.examSetting)===null||n===void 0?void 0:n.minSubmitMinutes)||0,b=D+O*60*1e3,!(O>0&&new Date().getTime()<b&&g!==!0)){c.next=11;break}return L.default.error("\u672A\u5230\u4EA4\u5377\u65F6\u95F4"),this.saving=!1,c.abrupt("return");case 11:return c.next=13,y.hi.post(this.getUrlWithToken("/api/public/saveAnswer"),T);case 13:return h=c.sent,(0,s.aD)(function(){h.success&&(h.data.answerId?u.answerId=h.data.answerId:h.data.examScore!==void 0,u.answerView=h.data,u.values=r,u.success=!0,localStorage.removeItem(u.tempSaveId)),u.saving=!1}),c.abrupt("return",h);case 16:case"end":return c.stop()}},i,this)}));function e(i,r){return t.apply(this,arguments)}return e}()},{key:"loadStatistics",value:function(){var t=(0,m.Z)((0,v.Z)().mark(function i(){var r=this,a;return(0,v.Z)().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(!this.loading){n.next=2;break}return n.abrupt("return");case 2:return this.loading=!0,n.next=5,y.hi.post(this.getUrlWithToken("/api/public/statistics"),{id:this.id});case 5:a=n.sent,(0,s.aD)(function(){a.success&&(r.statistics=a.data),r.loading=!1});case 7:case"end":return n.stop()}},i,this)}));function e(){return t.apply(this,arguments)}return e}()},{key:"loadProject",value:function(){var t=(0,m.Z)((0,v.Z)().mark(function i(){var r=this,a;return(0,v.Z)().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return this.loading=!0,n.next=3,y.hi.post(this.getUrlWithToken("/api/public/loadProject"),{id:this.id,answerId:this.answerId,repoId:this.repoId,examExerciseType:this.examExerciseType});case 3:a=n.sent,(0,s.aD)(function(){if(a.success){var u,l,_;r.project=a.data,r.applyAnswerLocale((u=a.data.setting)===null||u===void 0||(l=u.answerSetting)===null||l===void 0?void 0:l.defaultLocale),r.loginRequired=a.data.loginRequired,r.initialQuestionScore=(_=a.data.examInfo)===null||_===void 0?void 0:_.questionScore,r.survey=a.data.survey,r.values=a.data.answer,a.data.answerId&&(r.answerId=a.data.answerId)}else r.errorMessage=a.message;r.errorCode=a.code,r.loading=!1});case 5:case"end":return n.stop()}},i,this)}));function e(){return t.apply(this,arguments)}return e}()},{key:"validate",value:function(){var t=(0,m.Z)((0,v.Z)().mark(function i(r){var a=this,o;return(0,v.Z)().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:return this.verifying=!0,u.next=3,y.hi.post(this.getUrlWithToken("/api/public/validateProject"),{id:this.id,answer:r,answerId:this.answerId});case 3:o=u.sent,(0,s.aD)(function(){if(o.success){var l,_,g;a.project=o.data,a.applyAnswerLocale((l=o.data.setting)===null||l===void 0||(_=l.answerSetting)===null||_===void 0?void 0:_.defaultLocale),a.loginRequired=!1,a.survey=o.data.survey,a.whitelistName=(g=r.whitelistName)===null||g===void 0?void 0:g.whitelistName}else L.default.error(o.message);a.verifying=!1});case 5:case"end":return u.stop()}},i,this)}));function e(i){return t.apply(this,arguments)}return e}()},{key:"upload",value:function(){var t=(0,m.Z)((0,v.Z)().mark(function i(r,a){return(0,v.Z)().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",y.hi.upload("/api/public/upload",(0,A.Z)({fileType:4,basePath:this.id},r),a));case 1:case"end":return n.stop()}},i,this)}));function e(i,r){return t.apply(this,arguments)}return e}()},{key:"changeProgress",value:function(e){this.progress=e}},{key:"getUrlWithToken",value:function(e){return k.stringifyUrl({url:e,query:{"sk-token":this.token}})}}]),I}()}}]);
